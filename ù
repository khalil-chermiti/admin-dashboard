import { collection, getDocs, query, where } from "firebase/firestore";
import { databaseClient } from "../firebaseConfig";
import React, { useEffect, useState } from "react";
import toast from "react-hot-toast";
import { Card, Col, Container, Modal, Row } from "react-bootstrap";
import { IoMapOutline } from "react-icons/io5";
import { PointDeCollect } from "../CentreDeDepot/types";
import { Agent } from "../agents/types";

type Tournee = {
  id: string;
  agentId: string;
  pointsDeCollect: PointDeCollect[];
  agentName: string;
  supervisorId: string;
  camionMatricule: string;
};

type TourneeRealisee = {
  agentId: string;
  date: {
    seconds: number;
  };
  id: string;
  lat: number;
  lng: number;
  images: string[];
  agentNom?: string;
  agentPrenom?: string;
};

export const TourneesRealisees = () => {
  const [show, setShow] = useState(false);
  const handleShow = () => setShow(true);
  const handleClose = () => setShow(false);
  const [id, setId] = useState<string>("");
  const [nombreImages, setNombreImages] = useState<number>(0);

  const [tourneesRealisees, setTourneesRealisees] = useState<TourneeRealisee[]>(
    [],
  );

  // const authContext = useContext(AuthContext)!;

  const getTournees = async () => {
    const usersCollection = collection(databaseClient, "tourneesRealisees");
    const docSnap = query(usersCollection);

    await getDocs(docSnap).then((querySnapshot) => {
      if (querySnapshot.empty) {
        toast.error("Aucune tournée realisée trouvée");
      } else {
        querySnapshot.docs.map((doc) => {
          const currentTournee = doc.data() as TourneeRealisee;
          currentTournee.images = [];
          currentTournee.id = doc.id;
          setTourneesRealisees((prev) => [...prev, currentTournee]);
        });
      }
    });

    const photos = collection(databaseClient, "images");
    const photoSnap = query(photos);
    getDocs(photoSnap).then((querySnapshot) => {
      querySnapshot.docs.forEach((img) => {
        const currentImage = img.data();

        setTourneesRealisees((prev) => {
          const newTournees = prev.map((tournee) => {
            if (tournee.id === currentImage.tourneeId) {
              return {
                ...tournee,
                images: [...tournee.images, currentImage.imageUrl],
              };
            }
            return tournee;
          });
          return newTournees;
        });
      });
    });

    const agents = collection(databaseClient, "agents");
    const agentSnap = query(agents);
    getDocs(agentSnap).then((querySnapshot) => {
      querySnapshot.docs.forEach((agent) => {
        const currentAgent = agent.data();
        setTourneesRealisees((prev) => {
          const newTournees = prev.map((tournee) => {
            if (tournee.agentId === currentAgent.id) {
              return {
                ...tournee,
                agentNom: currentAgent.nom,
                agentPrenom: currentAgent.prenom,
              };
            }
            return tournee;
          });
          return newTournees;
        });
      });
    });
  };

  useEffect(() => {
    setTourneesRealisees([]);
    getTournees();
  }, []);

  return (
    <div className="mt-5">
      <Modal show={show} onHide={handleClose}>
        <Modal.Header closeButton>
          <Modal.Title>Ajouter Agent</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <ImprimerRapport handleClose={handleClose} id={id} />
        </Modal.Body>
      </Modal>

      <Container>
        <h3 className="mt-3 text-center">Liste des tournées realisees</h3>
        <Row className="mt-3" xs={2} md={8} lg={8}>
          {tourneesRealisees.map((tournee, index) => {
            return (
              <Col sm={12} md={6} lg={4} key={index} className="mb-2">
                <Card style={{ width: "18rem", marginBottom: "20px" }}>
                  <Card.Body>
                    <IoMapOutline size={35} className="m-1" />

                    <Card.Title>
                      <div
                        style={{
                          marginBottom: "10px",
                        }}
                      >
                        agent: {tournee.agentNom} {tournee.agentPrenom}
                      </div>
                      {tournee.images.map((img) => {
                        return (
                          <img
                            key={img}
                            src={img}
                            alt="tournee"
                            style={{
                              width: "100px",
                              height: "100px",
                              padding: "5px",
                            }}
                          />
                        );
                      })}
                    </Card.Title>
                    <Card.Subtitle className="mb-2 text-muted">
                      <div
                        style={{
                          marginBottom: "10px",
                        }}
                      >
                        images prises: {tournee.images.length}
                      </div>

                      <div
                        style={{
                          marginBottom: "10px",
                        }}
                      >
                        date: {new Date(tournee.date.seconds).toLocaleString()}
                      </div>
                      <button
                        className=" btn btn-primary"
                        onClick={() => {
                          setId(tournee.agentId);
                          setImages(tournee.images.length);
                          handleShow();
                        }}
                      >
                        Imprimer
                      </button>
                    </Card.Subtitle>
                  </Card.Body>
                </Card>
              </Col>
            );
          })}
        </Row>
      </Container>
    </div>
  );
};

const ImprimerRapport: React.FC<{
  id: string;
  handleClose: () => void;
  images: number;
}> = ({ id image }) => {
  const [tournee, setTournee] = useState<Tournee | null>(null);
  const [agent, setAgent] = useState<Agent | null>(null);

  const getTournee = async (id: string) => {
    const tournee = collection(databaseClient, "tournees");
    const docSnap = query(tournee, where("agentId", "==", id));

    const doc = await getDocs(docSnap);
    const currentTournee = doc.docs[0].data() as Tournee;
    setTournee(currentTournee);

    const agent = collection(databaseClient, "agents");
    const agentSnap = query(agent, where("id", "==", currentTournee.agentId));
    const agentDoc = await getDocs(agentSnap);
    const currentAgent = agentDoc.docs[0].data() as Agent;
    setAgent(currentAgent);
  };

  useEffect(() => {
    if (id) getTournee(id);
  }, []);

  useEffect(() => {
    console.log(tournee);
  }, [tournee]);

  return (
    <>
      {tournee && agent ? (
        <div>
          <h3 className="text-center mb-3">Rapport de la tournée</h3>
          <div>
            <h4>
              Agent: {agent.nom} {agent.prenom}
            </h4>
            <h4>Matricule du camion: {tournee.camionMatricule}</h4>
            <h4>Superviseur: {tournee.supervisorId}</h4>
            <h4>Images Prises: {}</h4>
          </div>
          <div className="mb-5">
            <h4>Points de collecte</h4>
            <ul>
              {tournee.pointsDeCollect.map((point, index) => {
                return (
                  <li key={index}>
                    {point.lat} - {point.lng}
                  </li>
                );
              })}
            </ul>
          </div>
        </div>
      ) : (
        <div>Chargement...</div>
      )}
    </>
  );
};
